---
title: "Gene mapping table"
author: "Frank Wessely"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
---

# Notes

* ensembl mapping file needed for `annotate_sce()`
* pre-compute on laptop via `map_ensembl_gene_id()`
* 4 columns are in output table: c("ensembl_gene_id", "gene_biotype", "external_gene_name", "percentage_gene_gc_content")
* those 4 columns seem to be needed
* here, modify the output gene table:
* 1. add ensembl ID if no gene symbol identified
* 2. add gene description as 5th column - will be imported and part of rowData in SingleCellExperiment object


```{r setup, include=FALSE}

library(knitr)
library(data.table)
library(DT)
library("EWCE", lib.loc = "/Users/frankwessely/Desktop/Documents/Tools/Older_R_packages")
library(scFlow)

knitr::opts_chunk$set(cache=TRUE,echo=FALSE,message=FALSE,warning=FALSE,cache.lazy=FALSE)
```


```{r files, include=F}

## corresponds to genes listed in features.tsv.gz of Cell Ranger output
ens_annot_file <- "/Users/frankwessely/Desktop/Documents/Projects/BBB/Endo_10X_Main/Analysis/Gene_info/ensembl_v106_gene_map.txt"

out_file <- "/Users/frankwessely/Desktop/Documents/Projects/BBB/Endo_10X_Main/Analysis/Gene_info/map_ensembl_scflow_v106.txt"
```


```{r processing}

gene_table <- fread(ens_annot_file)

## get info via biomart
## some genes without external gene name
map_ensembl_scflow_biomart <- map_ensembl_gene_id(ensembl_ids = gene_table$ens_gene, species = "human")

## just use existing table information:
map_ensembl_scflow <- gene_table[, .(ens_gene, gene_type, ext_gene, description)]
setnames(map_ensembl_scflow, c("ensembl_gene_id", "gene_biotype", "external_gene_name", "description"))

map_ensembl_scflow_biomart <- data.table(map_ensembl_scflow_biomart)
map_ensembl_scflow_biomart[external_gene_name == "", external_gene_name := ensembl_gene_id]
map_ensembl_scflow_biomart <- merge(map_ensembl_scflow_biomart, map_ensembl_scflow[, .(ensembl_gene_id, description)], by = "ensembl_gene_id")

# save table
write.table(map_ensembl_scflow_biomart, out_file, sep = "\t", quote = F, row.names = F, col.names = T)
```

***

# SessionInfo

```{r session_info, cache=F}

devtools::session_info()
```
