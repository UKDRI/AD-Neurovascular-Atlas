---
title: Run scflow
execute:
  eval: false
bibliography: references.bib
---

# Custom config file

Note that by default the scw config uses the htc queue and we'd rather use our DRI nodes, so I'll overwrite that.

I'm also trying out Nextflow Tower for the first time, it should be nice for keeping an eye on runs, seeing resource usage and troubleshooting any issues.
Note that after I purl this config I'll manually update the Nextflow Tower token on hawk.

```{r}
#| purl: true
executor { 
  name = 'slurm' 
  queueSize = 10
  queue = 'c_vhighmem_dri1'
}

params {
  max_memory = 715.GB
  max_cpus = 35
  max_time = 112.h
}

tower {
  accessToken = keyring::key_get("hawk_nextflow_tower")
  enabled = true
}

process {
    clusterOptions = '--account=scw1329'
    beforeScript = 'module load singularity'
    withName: SCFLOW_MERGE {
      memory = 300.GB
    }
    withName: SCFLOW_INTEGRATE {
      memory = 710.GB
      time = 20.h
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_REDUCEDIMS {
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_CLUSTER {
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_REPORTINTEGRATED {
      cpus = 35
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_FINALIZE {
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_DIRICHLET {
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_DGE {
      memory = 710.GB
      queue = 'c_vhighmem_dri1'
    }
    withName: SCFLOW_PLOTREDDIMGENES {
      memory = 710.GB
      cpus = 35
      time = 20.h
      queue = 'c_vhighmem_dri1'
    }
}
```

There is a module one could load on hawk, but it isn't the most recent version of nextflow, so I'm using mamba as per the scw docs

```{r}
mamba activate nf-core
```

Note that I'm using the `dev-nf` branch to run.

There's two `nextflow run` calls, the first is with both our data and the Yang data, and the latter with just our data in case something goes wrong with that.
[@yang_human_2022]

```{r}
#| eval: false
#| purl: false
nextflow run combiz-nf-core-scflow-dev-nf/workflow/ -profile scw -c 03_data/990_processed_data/001_snrnaseq/06_scflow/pipeline.config --manifest 03_data/990_processed_data/001_snrnaseq/06_scflow/scflow_manifest_final.tsv --input 03_data/990_processed_data/001_snrnaseq/90_sample_info/sample_metadata.tsv --reddim_genes_yml 03_data/990_processed_data/001_snrnaseq/06_scflow/reddim_genes.yml --ensembl_mappings 03_data/990_processed_data/001_snrnaseq/06_scflow/ensembl_mappings.tsv -N Bernardo-HarringtonG@cardiff.ac.uk -resume -bg > 03_data/990_processed_data/001_snrnaseq/06_scflow/scflow.log
# version with our samples alone
nextflow run combiz-nf-core-scflow-dev-nf/workflow/ -profile scw -c 03_data/990_processed_data/001_snrnaseq/06_scflow/pipeline.config --manifest 03_data/990_processed_data/001_snrnaseq/06_scflow/scflow_manifest.tsv --input 03_data/990_processed_data/001_snrnaseq/90_sample_info/sample_metadata_ours.tsv --reddim_genes_yml 03_data/990_processed_data/001_snrnaseq/06_scflow/reddim_genes.yml --ensembl_mappings 03_data/990_processed_data/001_snrnaseq/06_scflow/ensembl_mappings.tsv -N Bernardo-HarringtonG@cardiff.ac.uk -resume -bg > 03_data/990_processed_data/001_snrnaseq/06_scflow/scflow.log
```

```{r}
#| eval: false
library(readr)
temp <- read_tsv(here::here("03_data/990_processed_data/001_snrnaseq/90_sample_info/sample_metadata.tsv"))
temp$donor_ID <- NULL
write_tsv(temp, here::here("03_data/990_processed_data/001_snrnaseq/90_sample_info/sample_metadata_temp.tsv"))
```

