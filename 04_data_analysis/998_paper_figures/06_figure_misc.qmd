---
title: Build figures
execute:
  eval: true
code-fold: true
---

# Building figures

Plot guidance for figures in cell here: [https://www.cell.com/figure-guidelines](https://www.cell.com/figure-guidelines)

Limit is 7 figures/tables, but more can go in supplement.

Width guidance:

- For 2-column formats (such as research articles and reviews), the sizes are 85 mm (1 column), 114 mm (1.5 columns), and 174 mm (full width of the page)

- TODO - look at the correlation of the MAGMA risk genes per celltype, see if there's unique co-expression. Then try by sample for a given celltype and see if there's variation (presumably by amyloid burden?). Maybe check braak stage.

# Load packages

```{r}
source(here::here("04_data_analysis/990_code_libraries/02_library-calls-for-renv.R"))
library(magick)
library(circlize)
library(Cairo)
library(rstatix)  # For statistical tests
library(ggpubr)   # For adding significance brackets

tar_config_set(store = here::here("_targets"))
```


```{r}
#| eval: false
knitr::purl("04_data_analysis/998_paper_figures/04_figures.qmd",
"temp-dotplot.R")
```

```{r}
source("04_data_analysis/998_paper_figures/00_figures_source.R")
```

# Figure 1 - method and demographic overview

```{r}
# Get seurat object
tar_load(sce)

# the full cell labels are long for plots, let's make abbreviated versions
celltypes_abbrev <-
  c(
    "Astrocyte-activated" = "Astro-A",
    "Astrocyte-quiescent" = "Astro-Q",
    "Ex-Neuron-ADARB2-ERBB4" = "Ex-Neuro-1",
    "Ex-Neuron-CBLN2-NRGN" = "Ex-Neuro-2",
    "Ex-Neuron-DLC1-HS3ST4" = "Ex-Neuro-3",
    "Ex-Neuron-L2-3-CBLN2-LINC02306-CUX2" = "Ex-Neuro-4",
    "Ex-Neuron-L3-5-RORB-PLCH1" = "Ex-Neuro-5",
    "Ex-Neuron-L4-5-RORB-IL1RAPL2" = "Ex-Neuro-6",
    "Ex-Neuron-L6-THEMIS-NFIA" = "Ex-Neuro-7",
    "In-Neuron-ADARB2-GRM7" = "In-Neuro-1",
    "In-Neuron-ADARB2-IL1RAPL2-CSCL14" = "In-Neuro-2",
    "In-Neuron-ADARB2-LAMP5-NRG1" = "In-Neuro-3",
    "In-Neuron-ADARB2-NRG1-RELN" = "In-Neuro-4",
    "In-Neuron-DPP10-MEF2C" = "In-Neuro-5",
    "In-Neuron-PRKG1-TBC1D4" = "In-Neuro-6",
    "In-Neuron-TRHDE-RALYL" = "In-Neuro-7",
    "Microglia-activated" = "Microglia-A",
    "Microglia-quiescent" = "Microglia-Q",
    "Microglia-vascular" = "Microglia-V",
    "Pericyte" = "Pericyte-1",
    "Perivascular Macrophage" = "Perivascular-M",
    "Perivascular" = "Perivascular-M",
    "Perivascular-FB" = "Perivascular-FB-1",
    "Perivascular-FB-KAZN2" = "Perivascular-FB-2",
    "T-cell-parenchymal-1" = "T-cell-P1",
    "T-cell-parenchymal-2" = "T-cell-P2",
    "T-cell-vascular" = "T-cell-V",
    "T-cell-mixed" = "T-cell-M",
    "Vascular-SMC" = "Vascular-SMC-1",
    "Vascular-SMC-LINC00486" = "Vascular-SMC-2"
  )

# Create a new column with abbreviated Idents
abbreviated_idents <- celltypes_abbrev[as.character(sce$subcelltype_annotations)]
abbreviated_idents <- if_else(is.na(abbreviated_idents), sce$subcelltype_annotations, abbreviated_idents)
names(abbreviated_idents) <- NULL
sce$abbreviated_idents <- abbreviated_idents
unique(sce$abbreviated_idents)
Idents(sce) <- sce$abbreviated_idents

celltypes_abbrev_level1 <-
  c(
    "mystery-cluster" = "EndoMT",
    "Neuron_ex" = "Ex-Neuro",
    "Neuron_in" = "In-Neuro"
  )
abbreviated_idents <- celltypes_abbrev_level1[as.character(sce$highlevel_manual_annotations)]
abbreviated_idents <- if_else(is.na(abbreviated_idents), sce$highlevel_manual_annotations, abbreviated_idents)
names(abbreviated_idents) <- NULL
sce$abbreviated_idents_level1 <- abbreviated_idents
unique(sce$abbreviated_idents_level1)
```

```{r}
celltype_abbrev_df <- data.frame(celltypes_abbrev) |> rownames_to_column("celltype")
readr::write_tsv(celltype_abbrev_df, here::here("05_figures/990_shared_figures/003_final_figures/001_data_for_plots/celltype_abbreviations.tsv"))
```

## EndoMT proportions by APOE

```{r}
# Extract metadata
meta <- sce@meta.data %>%
  dplyr::filter(prep == "V") |>
  dplyr::select(donor, apoe_status, diagnosis, abbreviated_idents)

# Filter for EndoMT populations
endomt_meta <- meta %>%
  dplyr::filter(abbreviated_idents %in% c("EndoMT_1", "EndoMT_2"))

# Count cells per donor / celltype
cell_counts <- endomt_meta %>%
  group_by(donor, apoe_status, diagnosis, abbreviated_idents) %>%
  summarise(count = n(), .groups = 'drop')

# Get total cells per donor (for proportion calculation)
total_cells <- meta %>%
  group_by(donor) %>%
  summarise(total = n(), .groups = 'drop')

# Join and compute proportion
cell_props <- cell_counts %>%
  left_join(total_cells, by = "donor") %>%
  mutate(proportion = count / total)

# Plot
ggplot(cell_props, aes(x = apoe_status, y = proportion, fill = abbreviated_idents)) +
  geom_boxplot(outlier.shape = NA, position = position_dodge(width=0.75)) +
  geom_jitter(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75), size = 1.5) +
  facet_wrap(~ diagnosis) +
  labs(x = "APOE Status", y = "Proportion of EndoMT cells") +
  theme_classic()
file <- here("05_figures/990_shared_figures/004_pseudotime/01_tradeseq/",
             "endomt_proportion_by_apoe.pdf")
ggsave(filename = file, width = 7, height = 7)
```

```{r}
# Get percentages of level 1 celltypes
celltype_counts <- table(sce$highlevel_manual_annotations)
total <- sum(celltype_counts)
percentages <- (celltype_counts / total) * 100
print(percentages)

# Get the number of endothelial cells per sample for Yang paper
total_endothelial_cells <- 36800
total_neurons <- 2600
number_of_samples <- 25
total_endothelial_cells / number_of_samples
total_neurons / number_of_samples

# And for us - note there's one more parenchymal sample than vascular
v_samples <- grepl("V", unique(sce$manifest)) |> sum()
p_samples <- grepl("P", unique(sce$manifest)) |> sum()
celltype_counts[names(celltype_counts) == "Endothelial"] / v_samples
celltype_counts[names(celltype_counts) == "Endothelial"] / v_samples +
celltype_counts[names(celltype_counts) == "mystery-cluster"] / v_samples

celltype_counts[names(celltype_counts) == "Neuron_in"] / p_samples +
celltype_counts[names(celltype_counts) == "Neuron_ex"] / p_samples

# Get percentages of level 2 celltypes
sce@meta.data |>
  dplyr::filter(prep == "V") |>
  dplyr::count(abbreviated_idents) |>
  dplyr::mutate(percent = round(n / sum(n) * 100, digits = 2))
celltype_counts <- table(sce$abbreviated_idents)
total <- sum(celltype_counts)
percentages <- (celltype_counts / total) * 100
print(percentages |> round(digits = 2))
```


```{r}
DotPlot(sce, features = c("AGBL1",
                          "ARHGAP15",
                          "DOCK2",
                          "RUNX1"))
```

### Endo-MT markers from paper

Let's check the markers for Endo-MT reported in [this paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10073145/)

```{r}
endomt_markers <- c("ACTA2", "FN1", "PECAM1", "LUM", "RAMP2", "IFI27", "TM4SF1", "GNG11", "TIMP3", "IGFBP7", "ID3", "CTGF")
DotPlot(sce, features = endomt_markers)
```

```{r}
#| fig-width: 7
#| fig-height: 12
VlnPlot(sce, features = c("pc_mito"), ncol = 1, group.by = "highlevel_manual_annotations", pt.size = 0)
```


```{r}
Idents(sce) <- str_replace_all(Idents(sce), "_", "-")
sce$highlevel_manual_annotations <- if_else(sce$highlevel_manual_annotations == "mystery-cluster", "EndoMT", sce$highlevel_manual_annotations)
sce$highlevel_manual_annotations <- str_replace_all(sce$highlevel_manual_annotations, "_", "-")
unique(sce$highlevel_manual_annotations)
```

### Get numbers of endomt nuclie numbers

```{r}
# Get percentage of endomt in samples at level 1
endomt_percent <- sce@meta.data |>
  dplyr::filter(prep == "V") |>
  dplyr::count(donor, highlevel_manual_annotations, diagnosis) |>
  dplyr::mutate(percent = n / sum(n) * 100, .by = donor) |>
  dplyr::filter(highlevel_manual_annotations == "EndoMT")

readr::write_csv(endomt_percent,
                 here::here("03_data/999_data_for_publication",
                            "endomt_level1_percent.csv"))
```

```{r}
endomt_nuclei_num <- sce@meta.data |>
  dplyr::filter(abbreviated_idents %in% c("EndoMT_1", "EndoMT_2")) |>
  dplyr::count(donor, abbreviated_idents, diagnosis)
readr::write_csv(endomt_nuclei_num,
                 here::here("03_data/999_data_for_publication",
                            "endomt_nuclei_num.csv"))
```

### Dotplot of top markers

```{r}
sce$abbreviated_idents <- str_replace_all(sce$abbreviated_idents, "_", "-")
assertthat::assert_that(sum(!(
  unique(Idents(sce)) %in% unique(sce$abbreviated_idents)
)) == 0)
file <- here::here("05_figures/990_shared_figures/003_final_figures",
                   "001_data_for_plots")
file_level2 <- here::here(file, "top_abbrev_ident_markers.tsv")
file_level1 <- here::here(file, "top_level1_markers.tsv")

# Find markers for each cell type
if(!file.exists(file_level2) | !file.exists(file_level1)) {

  plan("multisession", workers = 8)
  markers <- FindAllMarkers(sce,
                            only.pos = TRUE,  # Only positive markers
                            min.pct = 0.25,   # Gene detected in at least 25% of cells
                            logfc.threshold = 0.5)  # Minimum log fold change
  readr::write_tsv(markers, file_level2)

  Idents(sce) <- sce$highlevel_manual_annotations
  markers_level1 <- FindAllMarkers(sce,
                            only.pos = TRUE,  # Only positive markers
                            min.pct = 0.25,   # Gene detected in at least 25% of cells
                            logfc.threshold = 0.5)  # Minimum log fold change
  readr::write_tsv(markers_level1, file_level1)
} else {
  markers <- readr::read_tsv(file_level2)
  markers_level1 <- readr::read_tsv(file_level1)
}

tar_load(translated_id)

# Select top markers for each cell type
top_markers <- markers |>
  left_join(translated_id, by = join_by(gene == ensembl_gene_id)) |>
  dplyr::filter(hgnc_symbol != "" & !is.na(hgnc_symbol)) |>
  group_by(cluster) |>
  slice_max(n = 2, order_by = avg_log2FC)
top_markers_level1 <- markers_level1 |>
  left_join(translated_id, by = join_by(gene == ensembl_gene_id)) |>
  dplyr::filter(hgnc_symbol != "" & !is.na(hgnc_symbol)) |>
  group_by(cluster) |>
  slice_max(n = 2, order_by = avg_log2FC)


# Optional: Create a heatmap of top markers
level2_dotplot <- DotPlot(sce,
          features = unique(top_markers$hgnc_symbol)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(x = "", y = "")
level1_dotplot <- DotPlot(sce,
          features = unique(top_markers_level1$hgnc_symbol),
group.by = "highlevel_manual_annotations") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
level1_dotplot <- level1_dotplot +
  labs(x = "", y ="")
ggsave(here("05_figures/990_shared_figures/003_final_figures/000_sup_figures/level1_dotplot.pdf"), plot = level1_dotplot, width = 7, height = 7)
ggsave(here("05_figures/990_shared_figures/003_final_figures/000_sup_figures/level2_dotplot.pdf"), plot = level2_dotplot, width = 15, height = 9)
```

## Bar plot of cell proportions

```{r}
# Get metadata
meta_data <- sce@meta.data

readr::write_tsv(meta_data, here::here("03_data/999_data_for_publication/nuclei_meta_data.tsv"))

meta_data |>
  dplyr::select(manifest, age, sex, diagnosis) |>
  unique() |>
  dplyr::summarise(people = n(), median_age = median(age), iqr_age = IQR(age),
                   .by = c(diagnosis, sex))

# Calculate the percentage of cells in each fraction per cell type
percentages <- meta_data %>%
  group_by(abbreviated_idents, prep) %>%
  summarise(count = n()) %>%
  mutate(total = sum(count), percentage = (count / total) * 100) %>%
  ungroup()

# View the calculated percentages
head(percentages)

# Create the bar plot
bar_plot <- ggplot(percentages, aes(x = reorder(abbreviated_idents, -percentage * (prep == "V")), y = percentage, fill = prep)) +
  geom_bar(stat = "identity") +
 # geom_bar(stat = "identity", position = "dodge") +
  labs(x = "",
       y = "Percentage",
       fill = "Fraction") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#  scale_fill_custom()

# Display the plot
print(bar_plot)

# Save the plot
ggsave(here("05_figures/990_shared_figures/003_final_figures/bar_plot_P_vs_V.png"), plot = bar_plot, width = 6, height = 4, dpi = 300)
ggsave(here("05_figures/990_shared_figures/003_final_figures/bar_plot_P_vs_V.svg"), plot = bar_plot, width = 6, height = 4)
```

## Boxplot of number of nuclie per donor

```{r}
# Combined half violin plot, boxplot, and jittered points
num_nuclei <- meta_data |>
  dplyr::group_by(abbreviated_idents, donor, diagnosis) |>
  dplyr::summarise(num_nuclei = n())

num_nuclei |>
  ggplot(aes(x = abbreviated_idents, y = num_nuclei, fill = diagnosis)) +
  geom_boxplot(outlier.shape = NA) +  # Hide outliers to avoid overlap with jittered points
  geom_jitter(position = position_jitter(width = 0.2), alpha = 0.6) +
  #scale_fill_brewer(palette = "Set3") +  # Choose a color palette
  labs(x = NULL,
       y = "Number of Nuclei")

num_nuclei |>
  ggplot(aes(x = abbreviated_idents, y = num_nuclei, fill = diagnosis)) +
  #geom_violin(trim = FALSE, alpha = 0.5, position = position_nudge(x = 0.2)) +
  geom_boxplot(width = 0.1, position = position_nudge(x = 0.2), outlier.shape = NA) +
  geom_jitter(position = position_jitter(width = 0.1), alpha = 0.6, size = 0.3) +
  coord_flip() +  # Flip coordinates to make it a half violin plot
  labs(x = NULL,
       y = "Number of Nuclei")
num_nuclei |>
  ggplot(aes(x = abbreviated_idents, y = num_nuclei, fill = diagnosis)) +
  #geom_violin(trim = FALSE, alpha = 0.5, position = position_nudge(x = 0.2)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6) +
  geom_jitter(position = position_jitter(width = 0.1), alpha = 0.8, size = 0.3) +
  coord_flip() +  # Flip coordinates to make it a half violin plot
  labs(x = NULL,
       y = "Number of Nuclei")
boxplot <- num_nuclei |>
  ggplot(aes(x = abbreviated_idents, y = num_nuclei, fill = diagnosis)) +
  #geom_violin(trim = FALSE, alpha = 0.5, position = position_nudge(x = 0.2)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6) +
  geom_jitter(position = position_jitter(width = 0.1), alpha = 0.8, size = 0.3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = NULL,
       y = "Number of Nuclei")
```

### Cohort visualisation

```{r}
cohort <- sce@meta.data |>
  dplyr::select(donor, diagnosis, sex:age, Ethnicity, diagnosis_details,
                apoe_status) |>
  dplyr::distinct() |>
  as_tibble()

cohort |>
  dplyr::count(sex, diagnosis)
cohort |>
  summarise(median_age = median(age), iqr_age = IQR(age),
  .by = c(diagnosis, sex))

sce@meta.data |>
  dplyr::select(donor, diagnosis, sex, prep) |>
  dplyr::distinct() |>
  as_tibble() |>
  dplyr::summarise(n = n(), .by = c(diagnosis, prep))

age_plot <- ggplot(cohort, aes(x = sex, y = age, fill = diagnosis)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "", y = "Age")

age_plot <- ggplot(cohort, aes(x = sex, y = age, fill = diagnosis)) +
  geom_boxplot() +
  #geom_jitter(width = 0.3, alpha = 0.5) +
  theme_minimal() +
  labs(x = "", y = "Age", fill = "")
age_plot
ggsave(filename = here::here("05_figures/990_shared_figures/003_final_figures",
                             "000_sup_figures/cohort_boxplot.png"), plot = age_plot,
       width = 8, height = 8, units = "in", dpi = 300)
```

## Figure 4 - cellchat

```{r}
# differential number of interactions
# Note that red colours denote increased signalling in the second dataset compared to the first, and blue the inverse.
# In our case cases are the first group and controls the second.
img1 <- image_read_svg(here::here("05_figures/990_shared_figures/cellchat/differential_heatmap.svg"))
img1_gg <- ggdraw() + draw_image(img1)
# relative information flow
img2 <- image_read_svg(here::here("05_figures/990_shared_figures/cellchat/differential_information_flow_stacked.svg"))
img2_gg <- ggdraw() + draw_image(img2)
# Overall signalling
img3 <- image_read_svg(here::here("05_figures/990_shared_figures/cellchat/differential_heatmap_overall.svg"))
img3_gg <- ggdraw() + draw_image(img3)
# example bubble plot
img4 <- image_read(here::here("05_figures/990_shared_figures/cellchat",
                              "003_differential_bubble_plots",
                              "EndoMT-1_differential_signalling.png"))
img4_gg <- ggdraw() + draw_image(img4)

# Combine everything
final_plot <- plot_grid(img1_gg, img4_gg, img3_gg, ncol = 1, labels = c("A", "B", "C"), label_colour = "black")
final_plot

ggsave(filename = here::here("05_figures/990_shared_figures/003_final_figures/figure4.png"), plot = final_plot,
       width = 12, height = 16, units = "in", dpi = 300)
```
